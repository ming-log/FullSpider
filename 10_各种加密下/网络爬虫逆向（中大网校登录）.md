---
title: 网络爬虫逆向（中大网校登录）
date: 2023-05-08 16:04:34
tags:
 - 网络爬虫逆向
 - python
categories:
 - 技术
mathjax: true
---

目标网址：https://user.wangxiao.cn/login?url=https%3A%2F%2Fwww.wangxiao.cn%2F

案例目标：网页账号密码模拟登录，获取对应的题库内容。

<!-- more -->

![image-20230508160812483](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508160812483.png)

# 网页分析

问题复现，随便输入账号、验证码和密码，然后点击登录。

![image-20230508162341501](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508162341501.png)

通过抓包查看请求内容。

![image-20230508180848295](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508180848295.png)

![image-20230508180641558](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508180641558.png)

从返回的结果可以看出，用于处理登录的数据包传输的`password`为加密格式，发送的是`POST`请求。

我们想要模拟这个登录请求，必须要做的一个事情就是分析该密码的加密逻辑，将自己登录传输的密码按照相同的加密逻辑进行加密，然后传输过去进行验证。

接下来开始分析其加密逻辑，点击启动器。前三个请求都是使用`jquery`发送。

![image-20230508181104556](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508181104556.png)

我们直接从第四个开始分析，点进去，打上断点。

![image-20230508181152930](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508181152930.png)

再次点击登录按钮，让其在断点处暂停。

![image-20230508181248335](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508181248335.png)

从`e`中的`url`可以看出，这个时候请求的地址为`/common/getTime`。我们释放此次断点。

![image-20230508181450915](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508181450915.png)

这个时候的`url`地址才是正常的。

![image-20230508181520715](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508181520715.png)

查看发送的`Ajax`请求中的`data`值。

![image-20230508181605296](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508181605296.png)

通过观察发现`data`的值是通过`i`赋值得到，在此处的密码已经被加密，我们需要往前找。

![image-20230508182047236](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508182047236.png)

在此处可以知道`i`是通过`e.data`来赋值得到，并且`e`中的`password`已经的被加密的，而`e`是通过函数传输过来的，这个时候就需要往前找调用这个函数的地方，传输过来的`e`是什么，查看前一步操作。这个时候就需要借助右下角的调用堆栈。

![image-20230508181723715](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508181723715.png)

![image-20230508182211409](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508182211409.png)

在这个地方是通过`zdAjax`接口对其进行调用，并且传入接口中有两个参数，第一个是`param`其作用就是将加密的数据传输过去；第二个是一个箭头函数，其作用暂时不清楚。再次利用右下角的调用堆栈，回到之前的调用栈，搞清楚箭头函数传输过去是做了什么事情。

![image-20230508185205112](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508185205112.png)

经过分析可以看到，这个箭头函数传输过来只在`Ajax`传输后对其进行了使用。

小结，`zdAjax(param, res => {})`作用为将`param`作为`Ajax`请求的参数发送到服务器的`"/apis/" + param.url`处，然后将服务器接收`param`参数后返回的数据，再传输作用再第二个箭头函数中。

再回到后一个调用栈，现在可以知道，`e`是通过该数据包中的`param`参数赋值得到，并且在这个地方`param`也是被加密的，继续向上找。

![image-20230508182433102](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508182433102.png)

往上找发现`param`参数中的`password`是通过`encryptFn(pwd + '' + ress.data)`该方式对密码进行加密，此处`pwd`即为实际输入的未加密的密码，而`param`中已经被加密了，说明`encryptFn`即为加密方法。

其中`ress.data`的值为`ress`传输过来的，而经过前面的分析`zdAjax`接口的作用是将`paramss`作为参数发送到服务器中的某个`url`地址，然后将返回的数据传输给第二个箭头函数。

换句话说，`ress`的值为`paramss`发送给服务器后的响应值。再网上找`paramss`看看是什么。

![image-20230508184909724](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508184909724.png)

可以看出，服务器接收参数的地址为`/common/getTime`，并且没有传输任何参数。

接下来看看加密方法`encryptFn`。

![image-20230508185541368](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508185541368.png)

点击来就可以看到关键字`setPublicKey`

![image-20230508185615112](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508185615112.png)

说明此处密码的加密方式就是`RSA`加密，并且公钥就再`"xxxx"`中。

PS：在分析网页的时候我们可以很明显的看到很多`keepOurCookie12`关键词，这说明该网址很有可能对网页的`Cookie`校验非常严格，可能调用JS对`Cookie`进行处理，这可能导致我们使用传统的`session`会话去保存登录状态无法解决登录问题。

现在加密方式和公钥都有了，顺利的话密码的加密问题应该已经可以解决。

除了账号和密码，在登录的时候还有一个验证码图片需要处理。查看验证码的请求方式。

![image-20230508190339303](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508190339303.png)

图片的请求是使用的`POST`请求方式，

API地址为`https://user.wangxiao.cn/apis//common/getImageCaptcha`

接下来查看其返回的内容，点击预览。

![image-20230508190559681](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508190559681.png)

可以看到图片的传输使用的是`base64`进行编码传输的。 我们可以将其获取下来，将其反向转化为字节后存储到本地即可看到正常图片内容。接下来可以人工识别或者调用第三方工具识别。

现在验证码和密码问题都已分析完成，开始进行代码编写。

# 代码编写

## 验证码识别

验证码识别问题相对简单点，我们先解决该问题。

直接请求`API`发现无法得到正常的图片数据。

![image-20230508191120812](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508191120812.png)

给其增加常见的请求头。

![image-20230508191432398](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508191432398.png)

通过在其发送`Ajax`请求时可以看到，在发送`Ajax`请求时有一个很特殊的参数`contentType`也被传输过去了。

![image-20230508191653759](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508191653759.png)

然后我们观察在请求头中也有这个参数，尝试把它加到请求头中进行访问。

![image-20230508191807039](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508191807039.png)

这个时候发现能够得到JSON数据了，但是服务器的响应时间明显增加了，并且数据还是不对，显示未知错误。

![image-20230508191931829](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508191931829.png)

这个时候时候通过观察`cookie`我们发现在其中有一个参数为`sessionId`值为`1683532405248`，这很有可能是一个与时间有关的参数，时间间隔太长导致请求失效了。

这个`cookie`是从哪里来的呢？我们关闭断点，直接刷新整个页面（注意：需要先清楚网页缓存），观察下在请求首页时候的`cookie`。

![image-20230508192407095](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508192407095.png)

可以看到在请求首页的时候，响应头中有个`Set-Cookie:sessionId=1683545006624; path=/`参数，其中就有我们想要的`sessionId`，该参数的作用就是给后面的访问设置`Cookie`。

这个时候我们可以点击密码登录查看验证码数据包`Cookie`中的`sessionId`值看看是否一致。

![image-20230508192729712](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508192729712.png)

通过比较可以发现确实是一致的。

所以要想请求到正确的图片数据，需要先请求首页让其设置`Cookie`后，再请求图片`API`。这个时候就需要使用到会话`Session`机制。

![image-20230508193136587](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508193136587.png)

这个时候发现请求结果正常。使用`base64`对其进行解码存储到本地。

![image-20230508193538657](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508193538657.png)

![image-20230508193554207](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508193554207.png)

图片显示正常。有两种方式：

1. 人工识别后输入
2. 调用第三方工具识别

解析来如何进行识别呢？在这里我们采用调用第三方工具的方式进行识别。

调用的是[图鉴](http://ttshitu.com/)的API。在其官网有对应的调用示例，我们直接赋值代码即可。

```python
import base64
import json
import requests

def base64_api(uname, pwd, img, typeid):
    with open(img, 'rb') as f:
        base64_data = base64.b64encode(f.read())
        b64 = base64_data.decode()
    data = {"username": uname, "password": pwd, "typeid": typeid, "image": b64}
    result = json.loads(requests.post("http://api.ttshitu.com/predict", json=data).text)
    if result['success']:
        return result["data"]["result"]
    else:
        #！！！！！！！注意：返回 人工不足等 错误情况 请加逻辑处理防止脚本卡死 继续重新 识别
        return result["message"]
    return ""
```

其中：

`uname`：用户账号

`pwd`：用户密码

`img`：用户图片地址

`typeid`：识别的图片种类，在官网可以查看，我们这里是数字和英文的组合即为3。

![image-20230508194142454](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508194142454.png)

按照要求填入内容。

![image-20230508194435182](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508194435182.png)

成功返回结果，验证码识别完成。

## 密码RSA加密

经过前面的分析，再进行密码加密的时候不是单纯的对密码加密，会加上一个`ress.data`这个参数是通过对服务器中的`/common/getTime`地址进行请求返回的结果。在抓包工具中也可以看到该数据包。

![image-20230508195049221](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508195049221.png)

使用`POST`请求该数据包，同样在请求头中加上`Content-Type`。

![image-20230508195306764](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508195306764.png)

结果返回正常。

筛选出`get_time`值，并为了后面代码编写，先定义好账号和密码（自己填写）。

![image-20230508195743060](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508195743060.png)

拼接好待加密参数

![image-20230508200009632](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508200009632.png)

经过前面的分析我们已经拿到`RSA`公钥，接下来使用RSA利用公钥对其进行加密，并将加密后的数据转化为`Base64`。

```js
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDA5Zq6ZdH/RMSvC8WKhp5gj6Ue4Lqjo0Q2PnyGbSkTlYku0HtVzbh3S9F9oHbxeO55E8tEEQ5wj/+52VMLavcuwkDypG66N6c1z0Fo2HgxV3e0tqt1wyNtmbwg7ruIYmFM+dErIpTiLRDvOy+0vgPcBVDfSUHwUSgUtIkyC47UNQIDAQAB
```

![image-20230508200702897](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508200702897.png)

加密成功，现在已经解决了在请求时需要使用到的所有参数。

## 开始发送登录请求

在发送请求时，注意将`data`表单转化为`JSON`格式。这个在`JS`源码中也可以看到，在获取到`e.data`时调用了一个`JSON.stringify()`方法。

![image-20230508201306167](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508201306167.png)

![image-20230508201144745](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508201144745.png)

这里登录成功了，我们是否可以直接使用`session`会话请求到其他页面内容呢？

例如我们请求某个模拟考试(http://ks.wangxiao.cn/TestPaper/getPaperRuleQuestions)，看是否能够拿到试题。

![image-20230508202315609](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508202315609.png)

![image-20230508202523643](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508202523643.png)

![image-20230508202719573](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508202719573.png)

发现无法正常请求该地址，又自动跳转到了登录页面。

![image-20230508202827218](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508202827218.png)

说明我们在此处通过`session`保存的`cookie`并没有保存到登录状态。这个就是我们前面说的该网站在处理`Cookie`时调用了JS对`Cookie`进行进一步处理。

对于这种情况只能通过分析网页`JS`后手动补全`Cookie`。

![image-20230508213612934](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508213612934.png)

![image-20230508213627352](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508213627352.png)

按照JS中写的手动补全`Cookie`。

![image-20230508214746537](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508214746537.png)

数据获取成功。

![image-20230508214813242](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20230508214813242.png)

# 完整代码

完整代码如下，其中账号密码需要手动填入。

```python
import json
import requests
import base64
from tujianAPI import base64_api  # 导入图鉴调用api的函数
from Crypto.Cipher import PKCS1_v1_5
from Crypto.PublicKey import RSA


# 处理验证码识别问题
login_page_url = 'https://user.wangxiao.cn/login'
img_api = 'https://user.wangxiao.cn/apis//common/getImageCaptcha'
session = requests.session()
session.headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36"
}
session.get(login_page_url)
img_resp = session.post(img_api, headers={"Content-Type": "application/json;charset=UTF-8"})
base64_img_code = img_resp.json()['data'].split(',')[-1]
base64_decode_img = base64.b64decode(base64_img_code)
with open('tu.png', 'wb') as f:
    f.write(base64_decode_img)
img_code = base64_api("", "", "tu.png", 3)  # 这里也需要补全图鉴网的账号和密码
# print(img_code)

# 处理密码加密问题
get_time_api = "https://user.wangxiao.cn/apis//common/getTime"
get_time_resp = session.post(get_time_api, headers={"Content-Type": "application/json;charset=UTF-8"})
get_time_code = get_time_resp.json()['data']

# # 定义账号密码
account = ''  # 中大网校账号
password = ''  # 中大网校密码

# # 拼接待加密参数
password_concat = password + get_time_code
# print(password_concat)

# ## 将待加密参数进行RSA加密
public_key_bs64 = "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDA5Zq6ZdH/RMSvC8WKhp5gj6Ue4Lqjo0Q2PnyGbSkTlYku0HtVzbh3S9F9oHbxeO55E8tEEQ5wj/+52VMLavcuwkDypG66N6c1z0Fo2HgxV3e0tqt1wyNtmbwg7ruIYmFM+dErIpTiLRDvOy+0vgPcBVDfSUHwUSgUtIkyC47UNQIDAQAB"
public_key = RSA.import_key(base64.b64decode(public_key_bs64))  # 将bs64格式的公钥转化为加密器所需格式
rsa_ = PKCS1_v1_5.new(key=public_key)  # 使用公钥创建加密器
mi_bytes = rsa_.encrypt(password_concat.encode('UTF-8'))  # RSA加密
mi_bs64 = base64.b64encode(mi_bytes).decode()


# 开始发送登录请求
login_api = 'https://user.wangxiao.cn/apis//login/passwordLogin'
data = {
    "imageCaptchaCode": img_code,
    "password": mi_bs64,
    "userName": account
}
login_resp = session.post(login_api, data=json.dumps(data), headers={"Content-Type": "application/json;charset=UTF-8"})
login_info = login_resp.json()
print(login_info)

# 手动补全Cookie
session.cookies['autoLogin'] = 'true'
session.cookies['userInfo'] = json.dumps(login_info['data'])
session.cookies['token'] = login_info['data']['token']
session.cookies['UserCookieName'] = login_info['data']['userName']
session.cookies['OldUsername2'] = login_info['data']['userNameCookies']
session.cookies['OldUsername'] = login_info['data']['userNameCookies']
session.cookies['OldPassword'] = login_info['data']['passwordCookies']
session.cookies['UserCookieName_'] = login_info['data']['userName']
session.cookies['OldUsername2_'] = login_info['data']['userNameCookies']
session.cookies['OldUsername_'] = login_info['data']['userNameCookies']
session.cookies['OldPassword_'] = login_info['data']['passwordCookies']
session.cookies[login_info['data']['userName'] + "_exam"] = login_info['data']['sign']

test_url = "http://ks.wangxiao.cn/TestPaper/getPaperRuleQuestions"
test_data = {
    "id": '21F74E2F-44FA-4550-B481-5EF80A4BA09F'
}
test_resp = session.post(test_url, data=json.dumps(test_data), headers={"Content-Type": "application/json;charset=UTF-8"})
print(test_resp.text)

```

`tujianAPI.py`

```python
import base64
import json
import requests

def base64_api(uname, pwd, img, typeid):
    with open(img, 'rb') as f:
        base64_data = base64.b64encode(f.read())
        b64 = base64_data.decode()
    data = {"username": uname, "password": pwd, "typeid": typeid, "image": b64}
    result = json.loads(requests.post("http://api.ttshitu.com/predict", json=data).text)
    if result['success']:
        return result["data"]["result"]
    else:
        #！！！！！！！注意：返回 人工不足等 错误情况 请加逻辑处理防止脚本卡死 继续重新 识别
        return result["message"]
    return ""
```